name: Encrypt Sensitive Script

on:
  workflow_dispatch:
    inputs:
      script_name:
        description: "è¦åŠ å¯†çš„è„šæœ¬æ–‡ä»¶å"
        required: true
        default: "sukisu_setup.sh"
      output_name:
        description: "è¾“å‡ºæ–‡ä»¶å"
        required: true
        default: "setup.bin"
      shc_options:
        description: "shc åŠ å¯†é€‰é¡¹"
        required: false
        default: "-T -S -v"

jobs:
  encrypt-script:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install shc and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y shc build-essential
        
    - name: Verify shc installation
      run: |
        if ! command -v shc &> /dev/null; then
          echo "âŒ shc æœªå®‰è£…"
          exit 1
        fi
        echo "âœ… shc å·²å®‰è£… - $(shc 2>&1 | head -n 1)"
        
    - name: Create encryption script
      run: |
        cat << 'EOF' > encrypt.sh
        #!/bin/bash
        
        # éªŒè¯è¾“å…¥æ–‡ä»¶å­˜åœ¨
        if [ ! -f "$INPUT_SCRIPT" ]; then
          echo "âŒ é”™è¯¯: æ–‡ä»¶ $INPUT_SCRIPT ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ·»åŠ åè°ƒè¯•ä¿æŠ¤
        sed -i '2i # åè°ƒè¯•ä¿æŠ¤\nif [ -n "$STRACE" ] || [ -n "$GDB" ]; then\n  echo "è°ƒè¯•å°è¯•è¢«é˜»æ­¢"\n  exit 1\nfi\n' "$INPUT_SCRIPT"
        
        # æ‰§è¡ŒåŠ å¯†
        echo "ðŸ”’ å¼€å§‹åŠ å¯†è„šæœ¬: $INPUT_SCRIPT"
        shc $SHC_OPTIONS -f "$INPUT_SCRIPT" -o "$OUTPUT_FILE"
        
        # éªŒè¯è¾“å‡º
        if [ ! -f "$OUTPUT_FILE" ]; then
          echo "âŒ é”™è¯¯: åŠ å¯†å¤±è´¥ï¼Œè¾“å‡ºæ–‡ä»¶æœªåˆ›å»º"
          exit 1
        fi
        
        echo "âœ… åŠ å¯†æˆåŠŸ! è¾“å‡ºæ–‡ä»¶: $OUTPUT_FILE"
        echo "æ–‡ä»¶ä¿¡æ¯:"
        file "$OUTPUT_FILE"
        echo "SHA256: $(sha256sum "$OUTPUT_FILE" | awk '{print $1}')"
        EOF
        
        chmod +x encrypt.sh
        
    - name: Encrypt the script
      run: |
        INPUT_SCRIPT="${{ github.event.inputs.script_name }}"
        OUTPUT_FILE="${{ github.event.inputs.output_name }}"
        SHC_OPTIONS="${{ github.event.inputs.shc_options }}"
        
        ./encrypt.sh
        
        SHA256=$(sha256sum "$OUTPUT_FILE" | awk '{print $1}')
        echo "ENCRYPTED_SHA256=$SHA256" >> $GITHUB_ENV
        echo "OUTPUT_FILENAME=$OUTPUT_FILE" >> $GITHUB_ENV
        
    - name: Upload encrypted binary
      uses: actions/upload-artifact@v4
      with:
        name: encrypted-script
        path: ${{ github.event.inputs.output_name }}
